

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Distributed Data &#8212; Akka Documentation</title>
    
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/prettify.css" type="text/css" />
    <link rel="stylesheet" href="../_static/base.css" type="text/css" />
    <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '@version@',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/toc.js"></script>
    <script type="text/javascript" src="../_static/prettify.js"></script>
    <script type="text/javascript" src="../_static/highlightCode.js"></script>
    <script type="text/javascript" src="../_static/effects.core.js"></script>
    <script type="text/javascript" src="../_static/effects.highlight.js"></script>
    <script type="text/javascript" src="../_static/scrollTo.js"></script>
    <script type="text/javascript" src="../_static/contentsFix.js"></script>
    <script type="text/javascript" src="../_static/ga.js"></script>
    <script type="text/javascript" src="../_static/warnOldDocs.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Akka Documentation" href="../index.html" />
    <link rel="up" title="Networking" href="index-network.html" />
    <link rel="next" title="Remoting" href="remoting.html" />
    <link rel="prev" title="Cluster Metrics Extension" href="cluster-metrics.html" />


  </head>
  <body role="document">
  <div class="navbar">
    <div class="navbar-inner">
      <div class="container">
        <div class="navbar-logo">
          <a href="http://akka.io"><img class="svg-logo" src="../_static/akka_full_color.svg" /></a>
        </div>
        <ul class="nav">
          <li><a href="http://akka.io/docs">Documentation</a></li>
          <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
          <li><a href="http://akka.io/downloads">Download</a></li>
          <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
          <li><a href="http://github.com/akka/akka">Code</a></li>
          <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
        </ul>
      </div>
    </div>
  </div>
  <div class="main">
    <div class="container">
      <div class="page-title">Distributed Data</div>
      <div class="pdf-link"><a href="../AkkaScala.pdf" title="Akka Scala Documentation"><img src="../_static/pdf-scala-icon.png" style="height: 40px;" /></a></div>
      <div class="pdf-link"><a href="../AkkaJava.pdf" title="Akka Java Documentation"><img src="../_static/pdf-java-icon.png" style="height: 40px;" /></a></div>
    </div>
    <div class="main-container">
      <div class="container">
        <div class="row">
          <div class="span12">
            <ul class="breadcrumb">
              <li>
                 <span class="divider">|</span> <a href="remoting.html">Remoting</a> <span class="divider">»</span>
              </li>
              <li>
                <a href="../java.html">Java Contents</a> <span class="divider">|</span> <a href="../scala.html">Scala Contents</a>
              </li>
              <li>
                <span class="divider">«</span> <a href="cluster-metrics.html">Cluster Metrics Extension</a> <span class="divider">|</span>
              </li>
              <li style="float: left">
                Version @version@
              </li>
              <li style="float: left">
                <input type="search" id="search" class="form-control" />
              </li>
            </ul>
          </div>
        </div>
        <div class="row"><div class="span9">
            
  <div class="section" id="distributed-data">
<span id="distributed-data-java"></span><h1>Distributed Data</h1>
<p><em>Akka Distributed Data</em> is useful when you need to share data between nodes in an
Akka Cluster. The data is accessed with an actor providing a key-value store like API.
The keys are unique identifiers with type information of the data values. The values
are <em>Conflict Free Replicated Data Types</em> (CRDTs).</p>
<p>All data entries are spread to all nodes, or nodes with a certain role, in the cluster
via direct replication and gossip based dissemination. You have fine grained control
of the consistency level for reads and writes.</p>
<p>The nature CRDTs makes it possible to perform updates from any node without coordination.
Concurrent updates from different nodes will automatically be resolved by the monotonic
merge function, which all data types must provide. The state changes always converge.
Several useful data types for counters, sets, maps and registers are provided and
you can also implement your own custom data types.</p>
<p>It is eventually consistent and geared toward providing high read and write availability
(partition tolerance), with low latency. Note that in an eventually consistent system a read may return an
out-of-date value.</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">This module is marked as <strong>“experimental”</strong> as of its introduction in Akka 2.4.0. We will continue to
improve this API based on our users’ feedback, which implies that while we try to keep incompatible
changes to a minimum the binary compatibility guarantee for maintenance releases does not apply to the
contents of the <code class="docutils literal"><span class="pre">akka.persistence</span></code> package.</p>
</div>
<div class="section" id="using-the-replicator">
<h2>Using the Replicator</h2>
<p>The <code class="docutils literal"><span class="pre">akka.cluster.ddata.Replicator</span></code> actor provides the API for interacting with the data.
The <code class="docutils literal"><span class="pre">Replicator</span></code> actor must be started on each node in the cluster, or group of nodes tagged
with a specific role. It communicates with other <code class="docutils literal"><span class="pre">Replicator</span></code> instances with the same path
(without address) that are running on other nodes . For convenience it can be used with the
<code class="docutils literal"><span class="pre">akka.cluster.ddata.DistributedData</span></code> extension.</p>
<p>Cluster members with status <a class="reference internal" href="cluster-usage.html#weakly-up-java"><span class="std std-ref">WeaklyUp</span></a>, if that feature is enabled,
will participate in Distributed Data. This means that the data will be replicated to the
<a class="reference internal" href="cluster-usage.html#weakly-up-java"><span class="std std-ref">WeaklyUp</span></a> nodes with the background gossip protocol. Note that it
will not participate in any actions where the consistency mode is to read/write from all
nodes or the majority of nodes. The <a class="reference internal" href="cluster-usage.html#weakly-up-java"><span class="std std-ref">WeaklyUp</span></a> node is not counted
as part of the cluster. So 3 nodes + 5 <a class="reference internal" href="cluster-usage.html#weakly-up-java"><span class="std std-ref">WeaklyUp</span></a> is essentially a
3 node cluster as far as consistent actions are concerned.</p>
<p>Below is an example of an actor that schedules tick messages to itself and for each tick
adds or removes elements from a <code class="docutils literal"><span class="pre">ORSet</span></code> (observed-remove set). It also subscribes to
changes of this.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="nc">SECONDS</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration.Duration</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.ThreadLocalRandom</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">akka.actor.AbstractActor</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.ActorRef</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.actor.Cancellable</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.Cluster</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.DistributedData</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.Key</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.ORSet</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.ORSetKey</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.Replicator</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.Replicator.Changed</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.Replicator.Subscribe</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.Replicator.Update</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.Replicator.UpdateResponse</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.event.Logging</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.event.LoggingAdapter</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.japi.pf.ReceiveBuilder</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">DataBot</span> <span class="k">extends</span> <span class="nc">AbstractActor</span> <span class="o">{</span>
  
  <span class="k">private</span> <span class="n">static</span> <span class="k">final</span> <span class="nc">String</span> <span class="nc">TICK</span> <span class="k">=</span> <span class="s">&quot;tick&quot;</span><span class="o">;</span>
  
  <span class="k">private</span> <span class="k">final</span> <span class="nc">LoggingAdapter</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">.</span><span class="n">getLogger</span><span class="o">(</span><span class="n">context</span><span class="o">().</span><span class="n">system</span><span class="o">(),</span> <span class="k">this</span><span class="o">);</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> 
      <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">context</span><span class="o">().</span><span class="n">system</span><span class="o">()).</span><span class="n">replicator</span><span class="o">();</span>
  <span class="k">private</span> <span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">context</span><span class="o">().</span><span class="n">system</span><span class="o">());</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">Cancellable</span> <span class="n">tickTask</span> <span class="k">=</span> <span class="n">context</span><span class="o">().</span><span class="n">system</span><span class="o">().</span><span class="n">scheduler</span><span class="o">().</span><span class="n">schedule</span><span class="o">(</span>
      <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">),</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">),</span> <span class="n">self</span><span class="o">(),</span> <span class="nc">TICK</span><span class="o">,</span>
      <span class="n">context</span><span class="o">().</span><span class="n">dispatcher</span><span class="o">(),</span> <span class="n">self</span><span class="o">());</span>

  <span class="k">private</span> <span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">dataKey</span> <span class="k">=</span> <span class="nc">ORSetKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;key&quot;</span><span class="o">);</span>
  
  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
  <span class="n">public</span> <span class="nc">DataBot</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span>
      <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="nc">TICK</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">receiveTick</span><span class="o">())</span>
      <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">Changed</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">dataKey</span><span class="o">),</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">receiveChanged</span><span class="o">((</span><span class="nc">Changed</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;)</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">.</span><span class="k">match</span><span class="o">(</span><span class="nc">UpdateResponse</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">receiveUpdateResoponse</span><span class="o">())</span>
      <span class="o">.</span><span class="n">build</span><span class="o">());</span>
  <span class="o">}</span>


  <span class="k">private</span> <span class="n">void</span> <span class="n">receiveTick</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">s</span> <span class="k">=</span> <span class="nc">String</span><span class="o">.</span><span class="n">valueOf</span><span class="o">((</span><span class="n">char</span><span class="o">)</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="n">current</span><span class="o">().</span><span class="n">nextInt</span><span class="o">(</span><span class="mi">97</span><span class="o">,</span> <span class="mi">123</span><span class="o">));</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="n">current</span><span class="o">().</span><span class="n">nextBoolean</span><span class="o">())</span> <span class="o">{</span>
      <span class="c1">// add</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Adding: {}&quot;</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
      <span class="nc">Update</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">update</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">&lt;&gt;(</span>
          <span class="n">dataKey</span><span class="o">,</span> 
          <span class="nc">ORSet</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span> 
          <span class="nc">Replicator</span><span class="o">.</span><span class="n">writeLocal</span><span class="o">(),</span> 
          <span class="n">curr</span> <span class="o">-&gt;</span>  <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">s</span><span class="o">));</span>
       <span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">update</span><span class="o">,</span> <span class="n">self</span><span class="o">());</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="c1">// remove</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Removing: {}&quot;</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
      <span class="nc">Update</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">update</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Update</span><span class="o">&lt;&gt;(</span>
          <span class="n">dataKey</span><span class="o">,</span> 
          <span class="nc">ORSet</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span> 
          <span class="nc">Replicator</span><span class="o">.</span><span class="n">writeLocal</span><span class="o">(),</span> 
          <span class="n">curr</span> <span class="o">-&gt;</span>  <span class="n">curr</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">s</span><span class="o">));</span>
      <span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">update</span><span class="o">,</span> <span class="n">self</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="k">private</span> <span class="n">void</span> <span class="n">receiveChanged</span><span class="o">(</span><span class="nc">Changed</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">data</span> <span class="k">=</span> <span class="n">c</span><span class="o">.</span><span class="n">dataValue</span><span class="o">();</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Current elements: {}&quot;</span><span class="o">,</span> <span class="n">data</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span>
  <span class="o">}</span>
  
  <span class="k">private</span> <span class="n">void</span> <span class="n">receiveUpdateResoponse</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// ignore</span>
  <span class="o">}</span>

  
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">void</span> <span class="n">preStart</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Subscribe</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">subscribe</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Subscribe</span><span class="o">&lt;&gt;(</span><span class="n">dataKey</span><span class="o">,</span> <span class="n">self</span><span class="o">());</span>
    <span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">subscribe</span><span class="o">,</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> 
  <span class="n">public</span> <span class="n">void</span> <span class="n">postStop</span><span class="o">(){</span>
    <span class="n">tickTask</span><span class="o">.</span><span class="n">cancel</span><span class="o">();</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="update">
<span id="replicator-update-java"></span><h3>Update</h3>
<p>To modify and replicate a data value you send a <code class="docutils literal"><span class="pre">Replicator.Update</span></code> message to the local
<code class="docutils literal"><span class="pre">Replicator</span></code>.</p>
<p>The current data value for the <code class="docutils literal"><span class="pre">key</span></code> of the <code class="docutils literal"><span class="pre">Update</span></code> is passed as parameter to the <code class="docutils literal"><span class="pre">modify</span></code>
function of the <code class="docutils literal"><span class="pre">Update</span></code>. The function is supposed to return the new value of the data, which
will then be replicated according to the given consistency level.</p>
<p>The <code class="docutils literal"><span class="pre">modify</span></code> function is called by the <code class="docutils literal"><span class="pre">Replicator</span></code> actor and must therefore be a pure
function that only uses the data parameter and stable fields from enclosing scope. It must
for example not access <code class="docutils literal"><span class="pre">sender()</span></code> reference of an enclosing actor.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">Update</span></code> is intended to only be sent from an actor running in same local <code class="docutils literal"><span class="pre">ActorSystem</span></code> as</dt>
<dd><ul class="first last simple">
<li>the <cite>Replicator</cite>, because the <cite>modify</cite> function is typically not serializable.</li>
</ul>
</dd>
</dl>
<p>You supply a write consistency level which has the following meaning:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">writeLocal</span></code> the value will immediately only be written to the local replica,
and later disseminated with gossip</li>
<li><code class="docutils literal"><span class="pre">writeTo(n)</span></code> the value will immediately be written to at least <code class="docutils literal"><span class="pre">n</span></code> replicas,
including the local replica</li>
<li><code class="docutils literal"><span class="pre">writeMajority</span></code> the value will immediately be written to a majority of replicas, i.e.
at least <strong>N/2 + 1</strong> replicas, where N is the number of nodes in the cluster
(or cluster role group)</li>
<li><code class="docutils literal"><span class="pre">writeAll</span></code> the value will immediately be written to all nodes in the cluster
(or all nodes in the cluster role group)</li>
</ul>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">replicator</span><span class="o">();</span>

<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">counter1Key</span> <span class="k">=</span> <span class="nc">PNCounterKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;counter1&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">set1Key</span> <span class="k">=</span> <span class="nc">GSetKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;set1&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">set2Key</span> <span class="k">=</span> <span class="nc">ORSetKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;set2&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">Flag</span><span class="o">&gt;</span> <span class="n">activeFlagKey</span> <span class="k">=</span> <span class="nc">FlagKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;active&quot;</span><span class="o">);</span>

<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Update</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span> <span class="nc">PNCounter</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span>
    <span class="nc">Replicator</span><span class="o">.</span><span class="n">writeLocal</span><span class="o">(),</span> <span class="n">curr</span> <span class="o">-&gt;</span> <span class="n">curr</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="mi">1</span><span class="o">)),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">WriteConsistency</span> <span class="n">writeTo3</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WriteTo</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Update</span><span class="o">&lt;</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;(</span><span class="n">set1Key</span><span class="o">,</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span>
    <span class="n">writeTo3</span><span class="o">,</span> <span class="n">curr</span> <span class="o">-&gt;</span> <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">WriteConsistency</span> <span class="n">writeMajority</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">WriteMajority</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Update</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;(</span><span class="n">set2Key</span><span class="o">,</span> <span class="nc">ORSet</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span>
    <span class="n">writeMajority</span><span class="o">,</span> <span class="n">curr</span> <span class="o">-&gt;</span> <span class="n">curr</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;hello&quot;</span><span class="o">)),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">WriteConsistency</span> <span class="n">writeAll</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WriteAll</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Update</span><span class="o">&lt;</span><span class="nc">Flag</span><span class="o">&gt;(</span><span class="n">activeFlagKey</span><span class="o">,</span> <span class="nc">Flag</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span>
    <span class="n">writeAll</span><span class="o">,</span> <span class="n">curr</span> <span class="o">-&gt;</span> <span class="n">curr</span><span class="o">.</span><span class="n">switchOn</span><span class="o">()),</span> <span class="n">getTestActor</span><span class="o">());</span>
</pre></div>
</div>
<p>As reply of the <code class="docutils literal"><span class="pre">Update</span></code> a <code class="docutils literal"><span class="pre">Replicator.UpdateSuccess</span></code> is sent to the sender of the
<code class="docutils literal"><span class="pre">Update</span></code> if the value was successfully replicated according to the supplied consistency
level within the supplied timeout. Otherwise a <code class="docutils literal"><span class="pre">Replicator.UpdateFailure</span></code> subclass is
sent back. Note that a <code class="docutils literal"><span class="pre">Replicator.UpdateTimeout</span></code> reply does not mean that the update completely failed
or was rolled back. It may still have been replicated to some nodes, and will eventually
be replicated to all nodes with the gossip protocol.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">UpdateSuccess</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// ok</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">UpdateSuccess</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">set1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// ok</span>
    <span class="o">}).</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">UpdateTimeout</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">set1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// write to 3 nodes failed within 1.second</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
</pre></div>
</div>
<p>You will always see your own writes. For example if you send two <code class="docutils literal"><span class="pre">Update</span></code> messages
changing the value of the same <code class="docutils literal"><span class="pre">key</span></code>, the <code class="docutils literal"><span class="pre">modify</span></code> function of the second message will
see the change that was performed by the first <code class="docutils literal"><span class="pre">Update</span></code> message.</p>
<p>In the <code class="docutils literal"><span class="pre">Update</span></code> message you can pass an optional request context, which the <code class="docutils literal"><span class="pre">Replicator</span></code>
does not care about, but is included in the reply messages. This is a convenient
way to pass contextual information (e.g. original sender) without having to use <code class="docutils literal"><span class="pre">ask</span></code>
or maintain local correlation data structures.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">replicator</span><span class="o">();</span>

<span class="k">final</span> <span class="nc">WriteConsistency</span> <span class="n">writeTwo</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">WriteTo</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">counter1Key</span> <span class="k">=</span> <span class="nc">PNCounterKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;counter1&quot;</span><span class="o">);</span>

<span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;increment&quot;</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// incoming command to increase the counter</span>
      <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">reqContext</span> <span class="k">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">getRef</span><span class="o">());</span>
      <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Update</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">upd</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Update</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span>
          <span class="nc">PNCounter</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span> <span class="n">writeTwo</span><span class="o">,</span> <span class="n">reqContext</span><span class="o">,</span> <span class="n">curr</span> <span class="o">-&gt;</span> <span class="n">curr</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
      <span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">upd</span><span class="o">,</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span>

    <span class="k">match</span><span class="o">(</span><span class="nc">UpdateSuccess</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">ActorRef</span> <span class="n">replyTo</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ActorRef</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="n">getRequest</span><span class="o">().</span><span class="n">get</span><span class="o">();</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;ack&quot;</span><span class="o">,</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span>

    <span class="k">match</span><span class="o">(</span><span class="nc">UpdateTimeout</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">ActorRef</span> <span class="n">replyTo</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ActorRef</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="n">getRequest</span><span class="o">().</span><span class="n">get</span><span class="o">();</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="s">&quot;nack&quot;</span><span class="o">,</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
</pre></div>
</div>
</div>
<div class="section" id="get">
<span id="replicator-get-java"></span><h3>Get</h3>
<p>To retrieve the current value of a data you send <code class="docutils literal"><span class="pre">Replicator.Get</span></code> message to the
<code class="docutils literal"><span class="pre">Replicator</span></code>. You supply a consistency level which has the following meaning:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">readLocal</span></code> the value will only be read from the local replica</li>
<li><code class="docutils literal"><span class="pre">readFrom(n)</span></code> the value will be read and merged from <code class="docutils literal"><span class="pre">n</span></code> replicas,
including the local replica</li>
<li><code class="docutils literal"><span class="pre">readMajority</span></code> the value will be read and merged from a majority of replicas, i.e.
at least <strong>N/2 + 1</strong> replicas, where N is the number of nodes in the cluster
(or cluster role group)</li>
<li><code class="docutils literal"><span class="pre">readAll</span></code> the value will be read and merged from all nodes in the cluster
(or all nodes in the cluster role group)</li>
</ul>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">replicator</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">counter1Key</span> <span class="k">=</span> <span class="nc">PNCounterKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;counter1&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">set1Key</span> <span class="k">=</span> <span class="nc">GSetKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;set1&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">set2Key</span> <span class="k">=</span> <span class="nc">ORSetKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;set2&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">Flag</span><span class="o">&gt;</span> <span class="n">activeFlagKey</span> <span class="k">=</span> <span class="nc">FlagKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;active&quot;</span><span class="o">);</span>

<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Get</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span>
    <span class="nc">Replicator</span><span class="o">.</span><span class="n">readLocal</span><span class="o">()),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">ReadConsistency</span> <span class="n">readFrom3</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReadFrom</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Get</span><span class="o">&lt;</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;(</span><span class="n">set1Key</span><span class="o">,</span>
    <span class="n">readFrom3</span><span class="o">),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">ReadConsistency</span> <span class="n">readMajority</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReadMajority</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Get</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;(</span><span class="n">set2Key</span><span class="o">,</span>
    <span class="n">readMajority</span><span class="o">),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">ReadConsistency</span> <span class="n">readAll</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReadAll</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Get</span><span class="o">&lt;</span><span class="nc">Flag</span><span class="o">&gt;(</span><span class="n">activeFlagKey</span><span class="o">,</span>
    <span class="n">readAll</span><span class="o">),</span> <span class="n">getTestActor</span><span class="o">());</span>
</pre></div>
</div>
<p>As reply of the <code class="docutils literal"><span class="pre">Get</span></code> a <code class="docutils literal"><span class="pre">Replicator.GetSuccess</span></code> is sent to the sender of the
<code class="docutils literal"><span class="pre">Get</span></code> if the value was successfully retrieved according to the supplied consistency
level within the supplied timeout. Otherwise a <code class="docutils literal"><span class="pre">Replicator.GetFailure</span></code> is sent.
If the key does not exist the reply will be <code class="docutils literal"><span class="pre">Replicator.NotFound</span></code>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">GetSuccess</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">GetSuccess</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">g</span> <span class="k">=</span> <span class="n">a</span><span class="o">;</span>
      <span class="nc">BigInteger</span> <span class="n">value</span> <span class="k">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataValue</span><span class="o">().</span><span class="n">getValue</span><span class="o">();</span>
    <span class="o">}).</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">NotFound</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// key counter1 does not exist</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
</pre></div>
</div>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">GetSuccess</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">set1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">GetSuccess</span><span class="o">&lt;</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">g</span> <span class="k">=</span> <span class="n">a</span><span class="o">;</span>
      <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">value</span> <span class="k">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataValue</span><span class="o">().</span><span class="n">getElements</span><span class="o">();</span>
    <span class="o">}).</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">GetFailure</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">set1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// read from 3 nodes failed within 1.second</span>
    <span class="o">}).</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">NotFound</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">set1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// key set1 does not exist</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
</pre></div>
</div>
<p>You will always read your own writes. For example if you send a <code class="docutils literal"><span class="pre">Update</span></code> message
followed by a <code class="docutils literal"><span class="pre">Get</span></code> of the same <code class="docutils literal"><span class="pre">key</span></code> the <code class="docutils literal"><span class="pre">Get</span></code> will retrieve the change that was
performed by the preceding <code class="docutils literal"><span class="pre">Update</span></code> message. However, the order of the reply messages are
not defined, i.e. in the previous example you may receive the <code class="docutils literal"><span class="pre">GetSuccess</span></code> before
the <code class="docutils literal"><span class="pre">UpdateSuccess</span></code>.</p>
<p>In the <code class="docutils literal"><span class="pre">Get</span></code> message you can pass an optional request context in the same way as for the
<code class="docutils literal"><span class="pre">Update</span></code> message, described above. For example the original sender can be passed and replied
to after receiving and transforming <code class="docutils literal"><span class="pre">GetSuccess</span></code>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">replicator</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">ReadConsistency</span> <span class="n">readTwo</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReadFrom</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">counter1Key</span> <span class="k">=</span> <span class="nc">PNCounterKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;counter1&quot;</span><span class="o">);</span>

<span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;get-count&quot;</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// incoming request to retrieve current value of the counter</span>
      <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">reqContext</span> <span class="k">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">getTestActor</span><span class="o">());</span>
      <span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Replicator</span><span class="o">.</span><span class="nc">Get</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span>
          <span class="n">readTwo</span><span class="o">),</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span>

    <span class="k">match</span><span class="o">(</span><span class="nc">GetSuccess</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">ActorRef</span> <span class="n">replyTo</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ActorRef</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="n">getRequest</span><span class="o">().</span><span class="n">get</span><span class="o">();</span>
      <span class="nc">GetSuccess</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">g</span> <span class="k">=</span> <span class="n">a</span><span class="o">;</span>
      <span class="n">long</span> <span class="n">value</span> <span class="k">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataValue</span><span class="o">().</span><span class="n">getValue</span><span class="o">().</span><span class="n">longValue</span><span class="o">();</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span>

    <span class="k">match</span><span class="o">(</span><span class="nc">GetFailure</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">ActorRef</span> <span class="n">replyTo</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ActorRef</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="n">getRequest</span><span class="o">().</span><span class="n">get</span><span class="o">();</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="n">tell</span><span class="o">(-</span><span class="mi">1L</span><span class="o">,</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span>

    <span class="k">match</span><span class="o">(</span><span class="nc">NotFound</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">ActorRef</span> <span class="n">replyTo</span> <span class="k">=</span> <span class="o">(</span><span class="nc">ActorRef</span><span class="o">)</span> <span class="n">a</span><span class="o">.</span><span class="n">getRequest</span><span class="o">().</span><span class="n">get</span><span class="o">();</span>
      <span class="n">replyTo</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="mi">0L</span><span class="o">,</span> <span class="n">getTestActor</span><span class="o">());</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
</pre></div>
</div>
</div>
<div class="section" id="consistency">
<h3>Consistency</h3>
<p>The consistency level that is supplied in the <a class="reference internal" href="#replicator-update-java"><span class="std std-ref">Update</span></a> and <a class="reference internal" href="#replicator-get-java"><span class="std std-ref">Get</span></a>
specifies per request how many replicas that must respond successfully to a write and read request.</p>
<p>For low latency reads you use <code class="docutils literal"><span class="pre">ReadLocal</span></code> with the risk of retrieving stale data, i.e. updates
from other nodes might not be visible yet.</p>
<p>When using <code class="docutils literal"><span class="pre">writeLocal</span></code> the update is only written to the local replica and then disseminated
in the background with the gossip protocol, which can take few seconds to spread to all nodes.</p>
<p><code class="docutils literal"><span class="pre">writeAll</span></code> and <code class="docutils literal"><span class="pre">readAll</span></code> is the strongest consistency level, but also the slowest and with
lowest availability. For example, it is enough that one node is unavailable for a <code class="docutils literal"><span class="pre">Get</span></code> request
and you will not receive the value.</p>
<p>If consistency is important, you can ensure that a read always reflects the most recent
write by using the following formula:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="o">(</span><span class="n">nodes_written</span> <span class="o">+</span> <span class="n">nodes_read</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">N</span>
</pre></div>
</div>
<p>where N is the total number of nodes in the cluster, or the number of nodes with the role that is
used for the <code class="docutils literal"><span class="pre">Replicator</span></code>.</p>
<p>For example, in a 7 node cluster this these consistency properties are achieved by writing to 4 nodes
and reading from 4 nodes, or writing to 5 nodes and reading from 3 nodes.</p>
<p>By combining <code class="docutils literal"><span class="pre">writeMajority</span></code> and <code class="docutils literal"><span class="pre">readMajority</span></code> levels a read always reflects the most recent write.
The <code class="docutils literal"><span class="pre">Replicator</span></code> writes and reads to a majority of replicas, i.e. <strong>N / 2 + 1</strong>. For example,
in a 5 node cluster it writes to 3 nodes and reads from 3 nodes. In a 6 node cluster it writes
to 4 nodes and reads from 4 nodes.</p>
<p>Here is an example of using <code class="docutils literal"><span class="pre">writeMajority</span></code> and <code class="docutils literal"><span class="pre">readMajority</span></code>:</p>
<p>In some rare cases, when performing an <code class="docutils literal"><span class="pre">Update</span></code> it is needed to first try to fetch latest data from
other nodes. That can be done by first sending a <code class="docutils literal"><span class="pre">Get</span></code> with <code class="docutils literal"><span class="pre">ReadMajority</span></code> and then continue with
the <code class="docutils literal"><span class="pre">Update</span></code> when the <code class="docutils literal"><span class="pre">GetSuccess</span></code>, <code class="docutils literal"><span class="pre">GetFailure</span></code> or <code class="docutils literal"><span class="pre">NotFound</span></code> reply is received. This might be
needed when you need to base a decision on latest information or when removing entries from <code class="docutils literal"><span class="pre">ORSet</span></code>
or <code class="docutils literal"><span class="pre">ORMap</span></code>. If an entry is added to an <code class="docutils literal"><span class="pre">ORSet</span></code> or <code class="docutils literal"><span class="pre">ORMap</span></code> from one node and removed from another
node the entry will only be removed if the added entry is visible on the node where the removal is
performed (hence the name observed-removed set).</p>
<p>The following example illustrates how to do that:</p>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last"><em>Caveat:</em> Even if you use <code class="docutils literal"><span class="pre">writeMajority</span></code> and <code class="docutils literal"><span class="pre">readMajority</span></code> there is small risk that you may
read stale data if the cluster membership has changed between the <code class="docutils literal"><span class="pre">Update</span></code> and the <code class="docutils literal"><span class="pre">Get</span></code>.
For example, in cluster of 5 nodes when you <code class="docutils literal"><span class="pre">Update</span></code> and that change is written to 3 nodes:
n1, n2, n3. Then 2 more nodes are added and a <code class="docutils literal"><span class="pre">Get</span></code> request is reading from 4 nodes, which
happens to be n4, n5, n6, n7, i.e. the value on n1, n2, n3 is not seen in the response of the
<code class="docutils literal"><span class="pre">Get</span></code> request.</p>
</div>
</div>
<div class="section" id="subscribe">
<h3>Subscribe</h3>
<p>You may also register interest in change notifications by sending <code class="docutils literal"><span class="pre">Replicator.Subscribe</span></code>
message to the <code class="docutils literal"><span class="pre">Replicator</span></code>. It will send <code class="docutils literal"><span class="pre">Replicator.Changed</span></code> messages to the registered
subscriber when the data for the subscribed key is updated. Subscribers will be notified
periodically with the configured <code class="docutils literal"><span class="pre">notify-subscribers-interval</span></code>, and it is also possible to
send an explicit <code class="docutils literal"><span class="pre">Replicator.FlushChanges</span></code> message to the <code class="docutils literal"><span class="pre">Replicator</span></code> to notify the subscribers
immediately.</p>
<p>The subscriber is automatically removed if the subscriber is terminated. A subscriber can
also be deregistered with the <code class="docutils literal"><span class="pre">Replicator.Unsubscribe</span></code> message.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">replicator</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">counter1Key</span> <span class="k">=</span> <span class="nc">PNCounterKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;counter1&quot;</span><span class="o">);</span>

<span class="nc">BigInteger</span> <span class="n">currentValue</span> <span class="k">=</span> <span class="nc">BigInteger</span><span class="o">.</span><span class="n">valueOf</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

<span class="n">public</span> <span class="nc">MyActor</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">receive</span><span class="o">(</span><span class="nc">ReceiveBuilder</span><span class="o">.</span>
    <span class="k">match</span><span class="o">(</span><span class="nc">Changed</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">key</span><span class="o">().</span><span class="n">equals</span><span class="o">(</span><span class="n">counter1Key</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">Changed</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">g</span> <span class="k">=</span> <span class="n">a</span><span class="o">;</span>
      <span class="n">currentValue</span> <span class="k">=</span> <span class="n">g</span><span class="o">.</span><span class="n">dataValue</span><span class="o">().</span><span class="n">getValue</span><span class="o">();</span>
    <span class="o">}).</span>
      
    <span class="k">match</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="n">class</span><span class="o">,</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="n">equals</span><span class="o">(</span><span class="s">&quot;get-count&quot;</span><span class="o">),</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="c1">// incoming request to retrieve current value of the counter</span>
      <span class="n">sender</span><span class="o">().</span><span class="n">tell</span><span class="o">(</span><span class="n">currentValue</span><span class="o">,</span> <span class="n">sender</span><span class="o">());</span>
    <span class="o">}).</span><span class="n">build</span><span class="o">());</span>
<span class="o">}</span>

<span class="n">public</span> <span class="n">void</span> <span class="n">preStart</span><span class="o">()</span> <span class="o">{</span>
  <span class="c1">// subscribe to changes of the Counter1Key value</span>
  <span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Subscribe</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span> <span class="n">self</span><span class="o">()),</span> <span class="nc">ActorRef</span><span class="o">.</span><span class="n">noSender</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="delete">
<h3>Delete</h3>
<p>A data entry can be deleted by sending a <code class="docutils literal"><span class="pre">Replicator.Delete</span></code> message to the local
local <code class="docutils literal"><span class="pre">Replicator</span></code>. As reply of the <code class="docutils literal"><span class="pre">Delete</span></code> a <code class="docutils literal"><span class="pre">Replicator.DeleteSuccess</span></code> is sent to
the sender of the <code class="docutils literal"><span class="pre">Delete</span></code> if the value was successfully deleted according to the supplied
consistency level within the supplied timeout. Otherwise a <code class="docutils literal"><span class="pre">Replicator.ReplicationDeleteFailure</span></code>
is sent. Note that <code class="docutils literal"><span class="pre">ReplicationDeleteFailure</span></code> does not mean that the delete completely failed or
was rolled back. It may still have been replicated to some nodes, and may eventually be replicated
to all nodes.</p>
<p>A deleted key cannot be reused again, but it is still recommended to delete unused
data entries because that reduces the replication overhead when new nodes join the cluster.
Subsequent <code class="docutils literal"><span class="pre">Delete</span></code>, <code class="docutils literal"><span class="pre">Update</span></code> and <code class="docutils literal"><span class="pre">Get</span></code> requests will be replied with <code class="docutils literal"><span class="pre">Replicator.DataDeleted</span></code>.
Subscribers will receive <code class="docutils literal"><span class="pre">Replicator.DataDeleted</span></code>.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">ActorRef</span> <span class="n">replicator</span> <span class="k">=</span> <span class="nc">DistributedData</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">).</span><span class="n">replicator</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;</span> <span class="n">counter1Key</span> <span class="k">=</span> <span class="nc">PNCounterKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;counter1&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">Key</span><span class="o">&lt;</span><span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">set2Key</span> <span class="k">=</span> <span class="nc">ORSetKey</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">&quot;set2&quot;</span><span class="o">);</span>

<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Delete</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span>
    <span class="nc">Replicator</span><span class="o">.</span><span class="n">writeLocal</span><span class="o">()),</span> <span class="n">getTestActor</span><span class="o">());</span>

<span class="k">final</span> <span class="nc">WriteConsistency</span> <span class="n">writeMajority</span> <span class="k">=</span>
    <span class="k">new</span> <span class="nc">WriteMajority</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="nc">SECONDS</span><span class="o">));</span>
<span class="n">replicator</span><span class="o">.</span><span class="n">tell</span><span class="o">(</span><span class="k">new</span> <span class="nc">Delete</span><span class="o">&lt;</span><span class="nc">PNCounter</span><span class="o">&gt;(</span><span class="n">counter1Key</span><span class="o">,</span>
    <span class="n">writeMajority</span><span class="o">),</span> <span class="n">getTestActor</span><span class="o">());</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">警告</p>
<p class="last">As deleted keys continue to be included in the stored data on each node as well as in gossip
messages, a continuous series of updates and deletes of top-level entities will result in
growing memory usage until an ActorSystem runs out of memory. To use Akka Distributed Data
where frequent adds and removes are required, you should use a fixed number of top-level data
types that support both updates and removals, for example <code class="docutils literal"><span class="pre">ORMap</span></code> or <code class="docutils literal"><span class="pre">ORSet</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="data-types">
<h2>Data Types</h2>
<p>The data types must be convergent (stateful) CRDTs and implement the <code class="docutils literal"><span class="pre">ReplicatedData</span></code> trait,
i.e. they provide a monotonic merge function and the state changes always converge.</p>
<p>You can use your own custom <code class="docutils literal"><span class="pre">ReplicatedData</span></code> types, and several types are provided
by this package, such as:</p>
<ul class="simple">
<li>Counters: <code class="docutils literal"><span class="pre">GCounter</span></code>, <code class="docutils literal"><span class="pre">PNCounter</span></code></li>
<li>Sets: <code class="docutils literal"><span class="pre">GSet</span></code>, <code class="docutils literal"><span class="pre">ORSet</span></code></li>
<li>Maps: <code class="docutils literal"><span class="pre">ORMap</span></code>, <code class="docutils literal"><span class="pre">ORMultiMap</span></code>, <code class="docutils literal"><span class="pre">LWWMap</span></code>, <code class="docutils literal"><span class="pre">PNCounterMap</span></code></li>
<li>Registers: <code class="docutils literal"><span class="pre">LWWRegister</span></code>, <code class="docutils literal"><span class="pre">Flag</span></code></li>
</ul>
<div class="section" id="counters">
<h3>Counters</h3>
<p><code class="docutils literal"><span class="pre">GCounter</span></code> is a &quot;grow only counter&quot;. It only supports increments, no decrements.</p>
<p>It works in a similar way as a vector clock. It keeps track of one counter per node and the total
value is the sum of these counters. The <code class="docutils literal"><span class="pre">merge</span></code> is implemented by taking the maximum count for
each node.</p>
<p>If you need both increments and decrements you can use the <code class="docutils literal"><span class="pre">PNCounter</span></code> (positive/negative counter).</p>
<p>It is tracking the increments (P) separate from the decrements (N). Both P and N are represented
as two internal <code class="docutils literal"><span class="pre">GCounter</span></code>. Merge is handled by merging the internal P and N counters.
The value of the counter is the value of the P counter minus the value of the N counter.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">PNCounter</span> <span class="n">c0</span> <span class="k">=</span> <span class="nc">PNCounter</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">PNCounter</span> <span class="n">c1</span> <span class="k">=</span> <span class="n">c0</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">PNCounter</span> <span class="n">c2</span> <span class="k">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="mi">7</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">PNCounter</span> <span class="n">c3</span> <span class="k">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">decrement</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">c3</span><span class="o">.</span><span class="n">value</span><span class="o">());</span> <span class="c1">// 6</span>
</pre></div>
</div>
<p>Several related counters can be managed in a map with the <code class="docutils literal"><span class="pre">PNCounterMap</span></code> data type.
When the counters are placed in a <code class="docutils literal"><span class="pre">PNCounterMap</span></code> as opposed to placing them as separate top level
values they are guaranteed to be replicated together as one unit, which is sometimes necessary for
related data.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">PNCounterMap</span> <span class="n">m0</span> <span class="k">=</span> <span class="nc">PNCounterMap</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">PNCounterMap</span> <span class="n">m1</span> <span class="k">=</span> <span class="n">m0</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">PNCounterMap</span> <span class="n">m2</span> <span class="k">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">decrement</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">PNCounterMap</span> <span class="n">m3</span> <span class="k">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">increment</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;b&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">m3</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">));</span> <span class="c1">// 5</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">m3</span><span class="o">.</span><span class="n">getEntries</span><span class="o">());</span>
</pre></div>
</div>
</div>
<div class="section" id="sets">
<h3>Sets</h3>
<p>If you only need to add elements to a set and not remove elements the <code class="docutils literal"><span class="pre">GSet</span></code> (grow-only set) is
the data type to use. The elements can be any type of values that can be serialized.
Merge is simply the union of the two sets.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s0</span> <span class="k">=</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s1</span> <span class="k">=</span> <span class="n">s0</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s2</span> <span class="k">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">).</span><span class="n">add</span><span class="o">(</span><span class="s">&quot;c&quot;</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">))</span>
  <span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">s2</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span>  <span class="c1">// a, b, c</span>
</pre></div>
</div>
<p>If you need add and remove operations you should use the <code class="docutils literal"><span class="pre">ORSet</span></code> (observed-remove set).
Elements can be added and removed any number of times. If an element is concurrently added and
removed, the add will win. You cannot remove an element that you have not seen.</p>
<p>The <code class="docutils literal"><span class="pre">ORSet</span></code> has a version vector that is incremented when an element is added to the set.
The version for the node that added the element is also tracked for each element in a so
called &quot;birth dot&quot;. The version vector and the dots are used by the <code class="docutils literal"><span class="pre">merge</span></code> function to
track causality of the operations and resolve concurrent updates.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s0</span> <span class="k">=</span> <span class="nc">ORSet</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s1</span> <span class="k">=</span> <span class="n">s0</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s2</span> <span class="k">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;b&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ORSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">s3</span> <span class="k">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">remove</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">s3</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span> <span class="c1">// b</span>
</pre></div>
</div>
</div>
<div class="section" id="maps">
<h3>Maps</h3>
<p><code class="docutils literal"><span class="pre">ORMap</span></code> (observed-remove map) is a map with <code class="docutils literal"><span class="pre">String</span></code> keys and the values are <code class="docutils literal"><span class="pre">ReplicatedData</span></code>
types themselves. It supports add, remove and delete any number of times for a map entry.</p>
<p>If an entry is concurrently added and removed, the add will win. You cannot remove an entry that
you have not seen. This is the same semantics as for the <code class="docutils literal"><span class="pre">ORSet</span></code>.</p>
<p>If an entry is concurrently updated to different values the values will be merged, hence the
requirement that the values must be <code class="docutils literal"><span class="pre">ReplicatedData</span></code> types.</p>
<p>It is rather inconvenient to use the <code class="docutils literal"><span class="pre">ORMap</span></code> directly since it does not expose specific types
of the values. The <code class="docutils literal"><span class="pre">ORMap</span></code> is intended as a low level tool for building more specific maps,
such as the following specialized maps.</p>
<p><code class="docutils literal"><span class="pre">ORMultiMap</span></code> (observed-remove multi-map) is a multi-map implementation that wraps an
<code class="docutils literal"><span class="pre">ORMap</span></code> with an <code class="docutils literal"><span class="pre">ORSet</span></code> for the map's value.</p>
<p><code class="docutils literal"><span class="pre">PNCounterMap</span></code> (positive negative counter map) is a map of named counters. It is a specialized
<code class="docutils literal"><span class="pre">ORMap</span></code> with <code class="docutils literal"><span class="pre">PNCounter</span></code> values.</p>
<p><code class="docutils literal"><span class="pre">LWWMap</span></code> (last writer wins map) is a specialized <code class="docutils literal"><span class="pre">ORMap</span></code> with <code class="docutils literal"><span class="pre">LWWRegister</span></code> (last writer wins register)
values.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ORMultiMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">m0</span> <span class="k">=</span> <span class="nc">ORMultiMap</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">ORMultiMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">m1</span> <span class="k">=</span> <span class="n">m0</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">,</span> 
    <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;(</span><span class="nc">Arrays</span><span class="o">.</span><span class="n">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">)));</span>
<span class="k">final</span> <span class="nc">ORMultiMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">m2</span> <span class="k">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">addBinding</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ORMultiMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">m3</span> <span class="k">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">removeBinding</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;a&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">ORMultiMap</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">m4</span> <span class="k">=</span> <span class="n">m3</span><span class="o">.</span><span class="n">addBinding</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;b&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">m4</span><span class="o">.</span><span class="n">getEntries</span><span class="o">());</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal"><span class="pre">LWWRegister</span></code> and therefore <code class="docutils literal"><span class="pre">LWWMap</span></code> relies on synchronized clocks and should only be used
when the choice of value is not important for concurrent updates occurring within the clock skew.</p>
<p>Instead of using timestamps based on <code class="docutils literal"><span class="pre">System.currentTimeMillis()</span></code> time it is possible to
use a timestamp value based on something else, for example an increasing version number
from a database record that is used for optimistic concurrency control.</p>
<p>When a data entry is changed the full state of that entry is replicated to other nodes, i.e.
when you update a map the whole map is replicated. Therefore, instead of using one <code class="docutils literal"><span class="pre">ORMap</span></code>
with 1000 elements it is more efficient to split that up in 10 top level <code class="docutils literal"><span class="pre">ORMap</span></code> entries
with 100 elements each. Top level entries are replicated individually, which has the
trade-off that different entries may not be replicated at the same time and you may see
inconsistencies between related entries. Separate top level entries cannot be updated atomically
together.</p>
</div>
<div class="section" id="flags-and-registers">
<h3>Flags and Registers</h3>
<p><code class="docutils literal"><span class="pre">Flag</span></code> is a data type for a boolean value that is initialized to <code class="docutils literal"><span class="pre">false</span></code> and can be switched
to <code class="docutils literal"><span class="pre">true</span></code>. Thereafter it cannot be changed. <code class="docutils literal"><span class="pre">true</span></code> wins over <code class="docutils literal"><span class="pre">false</span></code> in merge.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Flag</span> <span class="n">f0</span> <span class="k">=</span> <span class="nc">Flag</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
<span class="k">final</span> <span class="nc">Flag</span> <span class="n">f1</span> <span class="k">=</span> <span class="n">f0</span><span class="o">.</span><span class="n">switchOn</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">f1</span><span class="o">.</span><span class="n">enabled</span><span class="o">());</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">LWWRegister</span></code> (last writer wins register) can hold any (serializable) value.</p>
<p>Merge of a <code class="docutils literal"><span class="pre">LWWRegister</span></code> takes the register with highest timestamp. Note that this
relies on synchronized clocks. <cite>LWWRegister</cite> should only be used when the choice of
value is not important for concurrent updates occurring within the clock skew.</p>
<p>Merge takes the register updated by the node with lowest address (<code class="docutils literal"><span class="pre">UniqueAddress</span></code> is ordered)
if the timestamps are exactly the same.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">LWWRegister</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">r1</span> <span class="k">=</span> <span class="nc">LWWRegister</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;Hello&quot;</span><span class="o">);</span>
<span class="k">final</span> <span class="nc">LWWRegister</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">r2</span> <span class="k">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">withValue</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="s">&quot;Hi&quot;</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">r1</span><span class="o">.</span><span class="n">value</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; by &quot;</span> <span class="o">+</span> <span class="n">r1</span><span class="o">.</span><span class="n">updatedBy</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; at &quot;</span> <span class="o">+</span> <span class="n">r1</span><span class="o">.</span><span class="n">timestamp</span><span class="o">());</span>
</pre></div>
</div>
<p>Instead of using timestamps based on <code class="docutils literal"><span class="pre">System.currentTimeMillis()</span></code> time it is possible to
use a timestamp value based on something else, for example an increasing version number
from a database record that is used for optimistic concurrency control.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Record</span> <span class="o">{</span>
  <span class="n">public</span> <span class="k">final</span> <span class="n">int</span> <span class="n">version</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>

  <span class="n">public</span> <span class="nc">Record</span><span class="o">(</span><span class="n">int</span> <span class="n">version</span><span class="o">,</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nc">String</span> <span class="n">address</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">version</span> <span class="k">=</span> <span class="n">version</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">name</span> <span class="k">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">address</span> <span class="k">=</span> <span class="n">address</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>


  <span class="k">final</span> <span class="nc">Cluster</span> <span class="n">node</span> <span class="k">=</span> <span class="nc">Cluster</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">LWWRegister</span><span class="o">.</span><span class="nc">Clock</span><span class="o">&lt;</span><span class="nc">Record</span><span class="o">&gt;</span> <span class="n">recordClock</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">LWWRegister</span><span class="o">.</span><span class="nc">Clock</span><span class="o">&lt;</span><span class="nc">Record</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="n">public</span> <span class="n">long</span> <span class="n">apply</span><span class="o">(</span><span class="n">long</span> <span class="n">currentTimestamp</span><span class="o">,</span> <span class="nc">Record</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">version</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">};</span>

  <span class="k">final</span> <span class="nc">Record</span> <span class="n">record1</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Record</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">&quot;Alice&quot;</span><span class="o">,</span> <span class="s">&quot;Union Square&quot;</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">LWWRegister</span><span class="o">&lt;</span><span class="nc">Record</span><span class="o">&gt;</span> <span class="n">r1</span> <span class="k">=</span> <span class="nc">LWWRegister</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">record1</span><span class="o">);</span>

  <span class="k">final</span> <span class="nc">Record</span> <span class="n">record2</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Record</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">&quot;Alice&quot;</span><span class="o">,</span> <span class="s">&quot;Madison Square&quot;</span><span class="o">);</span>
  <span class="k">final</span> <span class="nc">LWWRegister</span><span class="o">&lt;</span><span class="nc">Record</span><span class="o">&gt;</span> <span class="n">r2</span> <span class="k">=</span> <span class="nc">LWWRegister</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">record2</span><span class="o">);</span>

  <span class="k">final</span> <span class="nc">LWWRegister</span><span class="o">&lt;</span><span class="nc">Record</span><span class="o">&gt;</span> <span class="n">r3</span> <span class="k">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">merge</span><span class="o">(</span><span class="n">r2</span><span class="o">);</span>
  <span class="nc">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="o">(</span><span class="n">r3</span><span class="o">.</span><span class="n">value</span><span class="o">());</span>
</pre></div>
</div>
<p>For first-write-wins semantics you can use the <code class="docutils literal"><span class="pre">LWWRegister#reverseClock</span></code> instead of the
<code class="docutils literal"><span class="pre">LWWRegister#defaultClock</span></code>.</p>
</div>
<div class="section" id="custom-data-type">
<h3>Custom Data Type</h3>
<p>You can rather easily implement your own data types. The only requirement is that it implements
the <code class="docutils literal"><span class="pre">mergeData</span></code> function of the <code class="docutils literal"><span class="pre">AbstractReplicatedData</span></code> class.</p>
<p>A nice property of stateful CRDTs is that they typically compose nicely, i.e. you can combine several
smaller data types to build richer data structures. For example, the <code class="docutils literal"><span class="pre">PNCounter</span></code> is composed of
two internal <code class="docutils literal"><span class="pre">GCounter</span></code> instances to keep track of increments and decrements separately.</p>
<p>Here is s simple implementation of a custom <code class="docutils literal"><span class="pre">TwoPhaseSet</span></code> that is using two internal <code class="docutils literal"><span class="pre">GSet</span></code> types
to keep track of addition and removals.  A <code class="docutils literal"><span class="pre">TwoPhaseSet</span></code> is a set where an element may be added and
removed, but never added again thereafter.</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">public</span> <span class="k">class</span> <span class="nc">TwoPhaseSet</span> <span class="k">extends</span> <span class="nc">AbstractReplicatedData</span><span class="o">&lt;</span><span class="nc">TwoPhaseSet</span><span class="o">&gt;</span> <span class="o">{</span>
  
  <span class="n">public</span> <span class="k">final</span> <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">adds</span><span class="o">;</span>
  <span class="n">public</span> <span class="k">final</span> <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">removals</span><span class="o">;</span>
  
  <span class="n">public</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">adds</span><span class="o">,</span> <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">removals</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">adds</span> <span class="k">=</span> <span class="n">adds</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">removals</span> <span class="k">=</span> <span class="n">removals</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="n">public</span> <span class="n">static</span> <span class="nc">TwoPhaseSet</span> <span class="n">create</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">(),</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="nc">TwoPhaseSet</span> <span class="n">add</span><span class="o">(</span><span class="nc">String</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="n">adds</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">element</span><span class="o">),</span> <span class="n">removals</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="n">public</span> <span class="nc">TwoPhaseSet</span> <span class="n">remove</span><span class="o">(</span><span class="nc">String</span> <span class="n">element</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="n">adds</span><span class="o">,</span> <span class="n">removals</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">element</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="n">public</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">getElements</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;(</span><span class="n">adds</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span>
    <span class="n">result</span><span class="o">.</span><span class="n">removeAll</span><span class="o">(</span><span class="n">removals</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">TwoPhaseSet</span> <span class="n">mergeData</span><span class="o">(</span><span class="nc">TwoPhaseSet</span> <span class="n">that</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">adds</span><span class="o">.</span><span class="n">merge</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="n">adds</span><span class="o">),</span> 
        <span class="k">this</span><span class="o">.</span><span class="n">removals</span><span class="o">.</span><span class="n">merge</span><span class="o">(</span><span class="n">that</span><span class="o">.</span><span class="n">removals</span><span class="o">));</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Data types should be immutable, i.e. &quot;modifying&quot; methods should return a new instance.</p>
<div class="section" id="serialization">
<h4>Serialization</h4>
<p>The data types must be serializable with an <a class="reference internal" href="serialization.html#serialization-java"><span class="std std-ref">Akka Serializer</span></a>.
It is highly recommended that you implement  efficient serialization with Protobuf or similar
for your custom data types. The built in data types are marked with <code class="docutils literal"><span class="pre">ReplicatedDataSerialization</span></code>
and serialized with <code class="docutils literal"><span class="pre">akka.cluster.ddata.protobuf.ReplicatedDataSerializer</span></code>.</p>
<p>Serialization of the data types are used in remote messages and also for creating message
digests (SHA-1) to detect changes. Therefore it is important that the serialization is efficient
and produce the same bytes for the same content. For example sets and maps should be sorted
deterministically in the serialization.</p>
<p>This is a protobuf representation of the above <code class="docutils literal"><span class="pre">TwoPhaseSet</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">option</span> <span class="n">java_package</span> <span class="k">=</span> <span class="s">&quot;docs.ddata.protobuf.msg&quot;</span><span class="o">;</span>
<span class="n">option</span> <span class="n">optimize_for</span> <span class="k">=</span> <span class="nc">SPEED</span><span class="o">;</span>

<span class="n">message</span> <span class="nc">TwoPhaseSet</span> <span class="o">{</span>
  <span class="n">repeated</span> <span class="n">string</span> <span class="n">adds</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span>
  <span class="n">repeated</span> <span class="n">string</span> <span class="n">removals</span> <span class="k">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The serializer for the <code class="docutils literal"><span class="pre">TwoPhaseSet</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">docs.ddata.japi.TwoPhaseSet</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">docs.ddata.protobuf.msg.TwoPhaseSetMessages</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">docs.ddata.protobuf.msg.TwoPhaseSetMessages.TwoPhaseSet.Builder</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">akka.actor.ExtendedActorSystem</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.GSet</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.protobuf.AbstractSerializationSupport</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">TwoPhaseSetSerializer</span> <span class="k">extends</span> <span class="nc">AbstractSerializationSupport</span> <span class="o">{</span>
  
  <span class="k">private</span> <span class="k">final</span> <span class="nc">ExtendedActorSystem</span> <span class="n">system</span><span class="o">;</span>

  <span class="n">public</span> <span class="nc">TwoPhaseSetSerializer</span><span class="o">(</span><span class="nc">ExtendedActorSystem</span> <span class="n">system</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">system</span> <span class="k">=</span> <span class="n">system</span><span class="o">;</span>
  <span class="o">}</span>
  
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">ExtendedActorSystem</span> <span class="n">system</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="n">system</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">boolean</span> <span class="n">includeManifest</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> 
  <span class="n">public</span> <span class="n">int</span> <span class="n">identifier</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="mi">99998</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">byte</span><span class="o">[]</span> <span class="n">toBinary</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="n">instanceof</span> <span class="nc">TwoPhaseSet</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">twoPhaseSetToProto</span><span class="o">((</span><span class="nc">TwoPhaseSet</span><span class="o">)</span> <span class="n">obj</span><span class="o">).</span><span class="n">toByteArray</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span>
          <span class="s">&quot;Can&#39;t serialize object of type &quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">getClass</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">Object</span> <span class="n">fromBinaryJava</span><span class="o">(</span><span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">manifest</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">twoPhaseSetFromBinary</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">protected</span> <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet</span> <span class="n">twoPhaseSetToProto</span><span class="o">(</span><span class="nc">TwoPhaseSet</span> <span class="n">twoPhaseSet</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Builder</span> <span class="n">b</span> <span class="k">=</span> <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet</span><span class="o">.</span><span class="n">newBuilder</span><span class="o">();</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">adds</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">twoPhaseSet</span><span class="o">.</span><span class="n">adds</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">adds</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">Collections</span><span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="n">adds</span><span class="o">);</span>
      <span class="n">b</span><span class="o">.</span><span class="n">addAllAdds</span><span class="o">(</span><span class="n">adds</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">removals</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">twoPhaseSet</span><span class="o">.</span><span class="n">removals</span><span class="o">.</span><span class="n">getElements</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">removals</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">Collections</span><span class="o">.</span><span class="n">sort</span><span class="o">(</span><span class="n">removals</span><span class="o">);</span>
      <span class="n">b</span><span class="o">.</span><span class="n">addAllRemovals</span><span class="o">(</span><span class="n">removals</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="k">protected</span> <span class="nc">TwoPhaseSet</span> <span class="n">twoPhaseSetFromBinary</span><span class="o">(</span><span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>  
      <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet</span> <span class="n">msg</span> <span class="k">=</span> 
          <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet</span><span class="o">.</span><span class="n">parseFrom</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
      <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">adds</span> <span class="k">=</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">elem</span> <span class="k">:</span> <span class="kt">msg.getAddsList</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">adds</span> <span class="k">=</span> <span class="n">adds</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">elem</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">removals</span> <span class="k">=</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
      <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">elem</span> <span class="k">:</span> <span class="kt">msg.getRemovalsList</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">removals</span> <span class="k">=</span> <span class="n">removals</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">elem</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="n">adds</span><span class="o">,</span> <span class="n">removals</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note that the elements of the sets are sorted so the SHA-1 digests are the same
for the same elements.</p>
<p>You register the serializer in configuration:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">akka</span><span class="o">.</span><span class="n">actor</span> <span class="o">{</span>
  <span class="n">serializers</span> <span class="o">{</span>
    <span class="n">twophaseset</span> <span class="k">=</span> <span class="s">&quot;docs.ddata.japi.protobuf.TwoPhaseSetSerializer&quot;</span>
  <span class="o">}</span>
  <span class="n">serialization</span><span class="o">-</span><span class="n">bindings</span> <span class="o">{</span>
    <span class="s">&quot;docs.ddata.japi.TwoPhaseSet&quot;</span> <span class="k">=</span> <span class="n">twophaseset</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Using compression can sometimes be a good idea to reduce the data size. Gzip compression is
provided by the <code class="docutils literal"><span class="pre">akka.cluster.ddata.protobuf.SerializationSupport</span></code> trait:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="nd">@Override</span>
<span class="n">public</span> <span class="n">byte</span><span class="o">[]</span> <span class="n">toBinary</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="n">instanceof</span> <span class="nc">TwoPhaseSet</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">compress</span><span class="o">(</span><span class="n">twoPhaseSetToProto</span><span class="o">((</span><span class="nc">TwoPhaseSet</span><span class="o">)</span> <span class="n">obj</span><span class="o">));</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span>
        <span class="s">&quot;Can&#39;t serialize object of type &quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">getClass</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="n">public</span> <span class="nc">Object</span> <span class="n">fromBinaryJava</span><span class="o">(</span><span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">manifest</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">twoPhaseSetFromBinary</span><span class="o">(</span><span class="n">decompress</span><span class="o">(</span><span class="n">bytes</span><span class="o">));</span>
<span class="o">}</span>
</pre></div>
</div>
<p>The two embedded <code class="docutils literal"><span class="pre">GSet</span></code> can be serialized as illustrated above, but in general when composing
new data types from the existing built in types it is better to make use of the existing
serializer for those types. This can be done by declaring those as bytes fields in protobuf:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="n">message</span> <span class="nc">TwoPhaseSet2</span> <span class="o">{</span>
  <span class="n">optional</span> <span class="n">bytes</span> <span class="n">adds</span> <span class="k">=</span> <span class="mi">1</span><span class="o">;</span>
  <span class="n">optional</span> <span class="n">bytes</span> <span class="n">removals</span> <span class="k">=</span> <span class="mi">2</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<p>and use the methods <code class="docutils literal"><span class="pre">otherMessageToProto</span></code> and <code class="docutils literal"><span class="pre">otherMessageFromBinary</span></code> that are provided
by the <code class="docutils literal"><span class="pre">SerializationSupport</span></code> trait to serialize and deserialize the <code class="docutils literal"><span class="pre">GSet</span></code> instances. This
works with any type that has a registered Akka serializer. This is how such an serializer would
look like for the <code class="docutils literal"><span class="pre">TwoPhaseSet</span></code>:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">docs.ddata.japi.TwoPhaseSet</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">docs.ddata.protobuf.msg.TwoPhaseSetMessages</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">docs.ddata.protobuf.msg.TwoPhaseSetMessages.TwoPhaseSet2.Builder</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>

<span class="k">import</span> <span class="nn">akka.actor.ExtendedActorSystem</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.GSet</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.protobuf.AbstractSerializationSupport</span><span class="o">;</span>
<span class="k">import</span> <span class="nn">akka.cluster.ddata.protobuf.ReplicatedDataSerializer</span><span class="o">;</span>

<span class="n">public</span> <span class="k">class</span> <span class="nc">TwoPhaseSetSerializer2</span> <span class="k">extends</span> <span class="nc">AbstractSerializationSupport</span> <span class="o">{</span>
  
  <span class="k">private</span> <span class="k">final</span> <span class="nc">ExtendedActorSystem</span> <span class="n">system</span><span class="o">;</span>
  <span class="k">private</span> <span class="k">final</span> <span class="nc">ReplicatedDataSerializer</span> <span class="n">replicatedDataSerializer</span><span class="o">;</span>

  <span class="n">public</span> <span class="nc">TwoPhaseSetSerializer2</span><span class="o">(</span><span class="nc">ExtendedActorSystem</span> <span class="n">system</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="n">system</span> <span class="k">=</span> <span class="n">system</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="n">replicatedDataSerializer</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReplicatedDataSerializer</span><span class="o">(</span><span class="n">system</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">ExtendedActorSystem</span> <span class="n">system</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="n">system</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">boolean</span> <span class="n">includeManifest</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span> 
  <span class="n">public</span> <span class="n">int</span> <span class="n">identifier</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="mi">99998</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="n">byte</span><span class="o">[]</span> <span class="n">toBinary</span><span class="o">(</span><span class="nc">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="n">instanceof</span> <span class="nc">TwoPhaseSet</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">twoPhaseSetToProto</span><span class="o">((</span><span class="nc">TwoPhaseSet</span><span class="o">)</span> <span class="n">obj</span><span class="o">).</span><span class="n">toByteArray</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span>
          <span class="s">&quot;Can&#39;t serialize object of type &quot;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">getClass</span><span class="o">());</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="n">public</span> <span class="nc">Object</span> <span class="n">fromBinaryJava</span><span class="o">(</span><span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">manifest</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">twoPhaseSetFromBinary</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">protected</span> <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet2</span> <span class="n">twoPhaseSetToProto</span><span class="o">(</span><span class="nc">TwoPhaseSet</span> <span class="n">twoPhaseSet</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Builder</span> <span class="n">b</span> <span class="k">=</span> <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet2</span><span class="o">.</span><span class="n">newBuilder</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">twoPhaseSet</span><span class="o">.</span><span class="n">adds</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">())</span>
      <span class="n">b</span><span class="o">.</span><span class="n">setAdds</span><span class="o">(</span><span class="n">otherMessageToProto</span><span class="o">(</span><span class="n">twoPhaseSet</span><span class="o">.</span><span class="n">adds</span><span class="o">).</span><span class="n">toByteString</span><span class="o">());</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">twoPhaseSet</span><span class="o">.</span><span class="n">removals</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">())</span>
      <span class="n">b</span><span class="o">.</span><span class="n">setRemovals</span><span class="o">(</span><span class="n">otherMessageToProto</span><span class="o">(</span><span class="n">twoPhaseSet</span><span class="o">.</span><span class="n">removals</span><span class="o">).</span><span class="n">toByteString</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">build</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
  <span class="k">protected</span> <span class="nc">TwoPhaseSet</span> <span class="n">twoPhaseSetFromBinary</span><span class="o">(</span><span class="n">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>  
      <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet2</span> <span class="n">msg</span> <span class="k">=</span> 
          <span class="nc">TwoPhaseSetMessages</span><span class="o">.</span><span class="nc">TwoPhaseSet2</span><span class="o">.</span><span class="n">parseFrom</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
      
      <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">adds</span> <span class="k">=</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="n">hasAdds</span><span class="o">())</span>
        <span class="n">adds</span> <span class="k">=</span> <span class="o">(</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">otherMessageFromBinary</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="n">getAdds</span><span class="o">().</span><span class="n">toByteArray</span><span class="o">());</span>
      
      <span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">removals</span> <span class="k">=</span> <span class="nc">GSet</span><span class="o">.</span><span class="n">create</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="n">hasRemovals</span><span class="o">())</span>
        <span class="n">adds</span> <span class="k">=</span> <span class="o">(</span><span class="nc">GSet</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;)</span> <span class="n">otherMessageFromBinary</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="n">getRemovals</span><span class="o">().</span><span class="n">toByteArray</span><span class="o">());</span>
      
      <span class="k">return</span> <span class="k">new</span> <span class="nc">TwoPhaseSet</span><span class="o">(</span><span class="n">adds</span><span class="o">,</span> <span class="n">removals</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="crdt-garbage">
<h3>CRDT Garbage</h3>
<p>One thing that can be problematic with CRDTs is that some data types accumulate history (garbage).
For example a <code class="docutils literal"><span class="pre">GCounter</span></code> keeps track of one counter per node. If a <code class="docutils literal"><span class="pre">GCounter</span></code> has been updated
from one node it will associate the identifier of that node forever. That can become a problem
for long running systems with many cluster nodes being added and removed. To solve this problem
the <code class="docutils literal"><span class="pre">Replicator</span></code> performs pruning of data associated with nodes that have been removed from the
cluster. Data types that need pruning have to implement the <code class="docutils literal"><span class="pre">RemovedNodePruning</span></code> trait.</p>
</div>
</div>
<div class="section" id="samples">
<h2>Samples</h2>
<p>Several interesting samples are included and described in the <a class="reference external" href="http://www.lightbend.com/platform/getstarted">Lightbend Activator</a>
tutorial named <a class="reference external" href="http://www.lightbend.com/activator/template/akka-sample-distributed-data-java">Akka Distributed Data Samples with Java</a>.</p>
<ul class="simple">
<li>Low Latency Voting Service</li>
<li>Highly Available Shopping Cart</li>
<li>Distributed Service Registry</li>
<li>Replicated Cache</li>
<li>Replicated Metrics</li>
</ul>
</div>
<div class="section" id="limitations">
<h2>Limitations</h2>
<p>There are some limitations that you should be aware of.</p>
<p>CRDTs cannot be used for all types of problems, and eventual consistency does not fit
all domains. Sometimes you need strong consistency.</p>
<p>It is not intended for <em>Big Data</em>. The number of top level entries should not exceed 100000.
When a new node is added to the cluster all these entries are transferred (gossiped) to the
new node. The entries are split up in chunks and all existing nodes collaborate in the gossip,
but it will take a while (tens of seconds) to transfer all entries and this means that you
cannot have too many top level entries. The current recommended limit is 100000. We will
be able to improve this if needed, but the design is still not intended for billions of entries.</p>
<p>All data is held in memory, which is another reason why it is not intended for <em>Big Data</em>.</p>
<p>When a data entry is changed the full state of that entry is replicated to other nodes. For example,
if you add one element to a Set with 100 existing elements, all 101 elements are transferred to
other nodes. This means that you cannot have too large data entries, because then the remote message
size will be too large. We might be able to make this more efficient by implementing
<a class="reference external" href="http://gsd.di.uminho.pt/members/cbm/ps/delta-crdt-draft16may2014.pdf">Efficient State-based CRDTs by Delta-Mutation</a>.</p>
<p>The data is only kept in memory. It is redundant since it is replicated to other nodes
in the cluster, but if you stop all nodes the data is lost, unless you have saved it
elsewhere. Making the data durable is a possible future feature, but even if we implement that
it is not intended to be a full featured database.</p>
</div>
<div class="section" id="learn-more-about-crdts">
<h2>Learn More about CRDTs</h2>
<ul class="simple">
<li><a class="reference external" href="http://www.ustream.tv/recorded/61448875">The Final Causal Frontier</a>
talk by Sean Cribbs</li>
<li><a class="reference external" href="https://vimeo.com/43903960">Eventually Consistent Data Structures</a>
talk by Sean Cribbs</li>
<li><a class="reference external" href="http://research.microsoft.com/apps/video/default.aspx?id=153540&amp;r=1">Strong Eventual Consistency and Conflict-free Replicated Data Types</a>
talk by Mark Shapiro</li>
<li><a class="reference external" href="http://hal.upmc.fr/file/index/docid/555588/filename/techreport.pdf">A comprehensive study of Convergent and Commutative Replicated Data Types</a>
paper by Mark Shapiro et. al.</li>
</ul>
<div class="section" id="dependencies">
<h3>Dependencies</h3>
<p>To use Distributed Data you must add the following dependency in your project.</p>
<p>sbt:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="s">&quot;com.typesafe.akka&quot;</span> <span class="o">%%</span> <span class="s">&quot;akka-distributed-data-experimental&quot;</span> <span class="o">%</span> <span class="s">&quot;@version@&quot;</span> <span class="nd">@crossString</span><span class="k">@</span>
</pre></div>
</div>
<p>maven:</p>
<div class="highlight-scala"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="o">.</span><span class="n">typesafe</span><span class="o">.</span><span class="n">akka</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">akka</span><span class="o">-</span><span class="n">distributed</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="n">experimental_@binVersion</span><span class="o">@&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">version</span><span class="o">&gt;@</span><span class="n">version</span><span class="o">@&lt;/</span><span class="n">version</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="configuration">
<h2>Configuration</h2>
<p>The <code class="docutils literal"><span class="pre">DistributedData</span></code> extension can be configured with the following properties:</p>
</div>
</div>


          </div>
          <div class="span3"><p class="contents-title">Contents</p>
              <div id="scroller-anchor">
                <div id="scroller">
                  <div id="toc"></div>
                </div>
              </div></div>
        </div>
      </div>
    </div>
  </div>
  <div class="footer">
  <div class="container">
    <ul>
      <li><h5>Akka</h5></li>
      <li><a href="http://akka.io/docs">Documentation</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/additional/faq.html">FAQ</a></li>
      <li><a href="http://akka.io/downloads">Downloads</a></li>
      <li><a href="http://akka.io/news">News</a></li>
      <li><a href="http://letitcrash.com">Blog</a></li>
    </ul>
    <ul>
      <li><h5>Contribute</h5></li>
      <li><a href="http://akka.io/community">Community Projects</a></li>
      <li><a href="http://github.com/akka/akka">Source Code</a></li>
      <li><a href="http://groups.google.com/group/akka-user">Mailing List</a></li>
      <li><a href="http://doc.akka.io/docs/akka/current/project/issue-tracking.html">Report a Bug</a></li>
    </ul>
    <ul>
      <li><h5>Company</h5></li>
      <li><a href="http://www.lightbend.com/how/subscription">Commercial Support</a></li>
      <li><a href="http://akka.io/team">Team</a></li>
      <li><a href="mailto:info@lightbend.com">Contact</a></li>
    </ul>
    <ul>
      <li><img src="../_static/akka_icon_reverse.svg" align="center"/></li>
    </ul>
  </div>
  <div class="container copyright">
    <p style="float: left;">
      © 2015 <a href="http://www.lightbend.com/">Lightbend Inc.</a> <span class="license">Akka is Open Source and available under the Apache 2 License.</span>
    </p>
    <p style="float: right; font-size: 12px;">
      Last updated: 10月 15, 2016
    </p>
  </div>
</div>
<script type="text/javascript">
  var $toc = $('#toc');
  $toc.toc();

  // show clickable section sign when section header hovered:
  $('.section h2,.section h3,.section h4,.section h5').each(function(i, el) {
      var $el = $(el);
      $el.prepend($("<a class='section-marker' href='#" + $el.attr("id") + "'>&sect;</a>"))
  });
</script>

<!-- Algolia docs search -->
<script type="text/javascript">
  var version = DOCUMENTATION_OPTIONS.VERSION;

  var lang = "scala";
  var path = window.location.pathname;
  if (path.includes("/java/") || path.includes("java.html")) lang = "java";

  console.log("Search configured for:", lang, "@", version);

  docsearch({
    apiKey: '543bad5ad786495d9ccd445ed34ed082',
    indexName: 'akka_io',
    inputSelector: '#search',
    algoliaOptions: {
      hitsPerPage: 5,
      facetFilters: '[' + '["language:' + lang + '","language:general"]' + ',"version:' + version + '"]'
    }
  });

  // set up "/" as global shortcut for focusing on search
  $(document).keypress(function (event) {
    if (event.keyCode == 47) {
      $("#q").focus();
      return false; // swallow key event, otherwise the / char would be input into the search box
    }
  });
</script>

  

  </body>
</html>